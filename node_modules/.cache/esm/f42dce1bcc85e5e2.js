let mongoose,productSchema,categorySchema;_cc8‍.x([["addNewProduct",()=>addNewProduct],["updateGalerie",()=>updateGalerie],["getAllProduct",()=>getAllProduct],["getProductsFeatures",()=>getProductsFeatures],["updateProductById",()=>updateProductById],["getProductById",()=>getProductById],["deleteProductById",()=>deleteProductById],["getProductCount",()=>getProductCount]]);_cc8‍.w("mongoose",[["default",["mongoose"],function(v){mongoose=v}]]);_cc8‍.w("../models/products",[["default",["productSchema"],function(v){productSchema=v}]]);_cc8‍.w("../models/category",[["default",["categorySchema"],function(v){categorySchema=v}]]);

 

const Product = mongoose.model("Product" ,productSchema) ;
const Category = mongoose.model("Category" , categorySchema) 


// 
     

const addNewProduct = async (req ,res) => {  
         // On vérifie d'abord si la categorie existe déja ans la base de donnée ! 
        //  le front end dans la categorie enverra l'id de la categorie que je veux ajouter 
        _cc8‍.g.console.log("l'id est ====>",req.body.category)
         let category = await Category.findById(req.body.category) 
         _cc8‍.g.console.log("la categorie qui extiste est ===>" , category)
         if(!category)  return res.status(400).send("Category invalide") 
         //Sinon on continue le processus
    try { 

       const {
        name ,  
        description ,
        richDescription ,
        brand , 
        price ,
        category ,
        countInStock  ,
        rating ,
        numReviews  ,
        isFeatured 
       } = req.body   

// On refuse la requete lorsqu'il n'a pas d'image ...
       const file = req.file;
       if (!file) return res.status(400).send("Pas d'image dans la requete");


    const image =`${req.protocol}://${req.get('host')}/public/uploads/${req.file.filename}` 
    _cc8‍.g.console.log("le file est ==>" , req.file)
    _cc8‍.g.console.log("mon image est ==>" , image)

    
       const product = new Product ( {
        name ,  
        description ,
        richDescription ,
          image ,
         brand , 
         price ,
         category ,
         countInStock   ,
         rating ,
         numReviews  ,
         isFeatured 
       }) 
       await product.save();
       if(product) {
           res.status(201).json(product)
       } 
       else {
           throw new Error("impossible d'jouter un produit ")
       }
        
    } catch (error) {
        _cc8‍.g.console.log(error)
        res.status(400).send(error)
    }

}  
const getAllProduct = async (req , res) =>  {
     try {  
        //   permet de filtrer les produits en fonction de la category 
         // si filter renvoie un  objet vide alors nous aurons la liste de nos produits initialement sans filtre    
    // sinon nous aurons les produits en fonction de la category 
        let filter = {}
        //On teste si on filtre les produits en fonction de la category 
        if( req.query.categories ) {  
            filter  = {
                category :  req.query.categories
            }
        } 
         const product  = await Product.find(filter) 
         if(product) {
             res.status(200).json(product)
         }
        else {
            throw new Error("Product not Found")
        }
    } catch (error) {
        res.status(404).send(error)
    }
}   


const getProductById = async (req ,res) => {
    try { 
        const product = await Product.findById(req.params.idpro).populate("category") 
        if (product) {
            res.status(200).send(product) 
        }
        else {
            throw new Error("product not found")
        }
        
    } catch (error) {
        res.status(404).send(error)
    }
} 
const updateProductById = async (req , res)=> { 
     // On vérifie d'abord si la categorie existe déja ! 
     let category = await Category.findById(req.body.category) 
     if(!category)  return res.status(400).send("Category invalide") 
     //Sinon on continue le processus  
     try { 
    //  Pour la modification on teste si l'admin a modifié l'image ou à garder l'ancien image .
        const mybody = req.file ? 
        {
            ...req.body ,
            image : `${req.protocol}://${req.get('host')}/public/uploads/${req.file.filename}`
        } 
          : 
          {
              ...req.body
          }

        const product = await Product.findByIdAndUpdate(
            
            req.params.idpro ,  
              
            mybody ,  
            // ceci veut dire que je retourne les nouvelles datas mis a jour .
            {
                new : true 
            }

        ) 
        if (product) {
            res.status(200).json({
                message : "Modification  avec succés" ,
                product : product
            })
        } 
        else  {
            throw new Error("Echec Modification ")
        }
        
    } catch (error) {
        res.status(400).send(error)
    }

} 
const deleteProductById = async(req ,res) => {
    try {
        const product = await Product.deleteOne({
            _id : req.params.idpro
        }) 
        if (product) {
            res.status(200).json({ 
                success : true ,
                message : "Suppression réussi"
            })
        } 
        else {
            throw new Error("suppression non réussi ")
        }
    } catch (error) {
        res.status(400).json({
            success : false , 
            message : error
        })
    }
}  
// Cette methode renvoie le nombre documents qui correspond à ma collection produit 
const getProductCount = async (req ,res) =>{
    try { 
        const productCount  = await Product.countDocuments({}) 
        
        if(productCount) {
            res.status(200).send({
                nombre :  productCount 
            })
        }
       else { 
      
           throw new Error("Product not Found")
       }
   } catch (error) {  
     
       res.status(404).send(error)
   } 
}

// fonction pour afficher les prduits dans la page d'acceuils ,les produits vedettes ...

const getProductsFeatures = async (req ,res) => {
    try { 
        //count designe le nombre limite de produit qui doit etre afficher à l'acceuil
        const count = req.params.count  ?  req.params.count  : 0
        const product  = await Product.find({
            isFeatured : true
        }).limit(parseInt(count))
        
        if(product) {
            res.status(200).send(product)
        }
      
   } catch (error) {  
     
       res.status(404).send(error)
   } 
} 

//Cette fonction permet de mettre à jour mon tableau d'images. 

const updateGalerie = async(req ,res) => {
     try { 
        const files = req.files;
        _cc8‍.g.console.log("my files sont ==>" , files)
        let imagesPaths = [];
        const basePath = `${req.protocol}://${req.get('host')}/public/uploads/`;

        if (files) {
            files.map((file) => {
                imagesPaths.push(`${basePath}${file.filename}`);
            });
        }

        const product = await Product.findByIdAndUpdate(
            req.params.idpro,
            {
                images: imagesPaths,
            },
            { new: true }
        );

        
        if (product) {
            res.status(200).json({
                message : "Modification images avec succés" ,
                product : product
            })
        } 
        else  {
            throw new Error("Echec Modification ")
        }
        
    } catch (error) { 
        _cc8‍.g.console.log(error)
        res.status(400).send(error)
    }

}

    



 